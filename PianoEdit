<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piano Koki - Samples Reales</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        h1 {
            font-weight: 300;
            font-size: 2.5em;
            color: #333;
            margin-bottom: 30px;
        }
        
        .controls {
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
        }
        
        button {
            padding: 10px 20px;
            border: 2px solid #333;
            background: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 300;
            border-radius: 5px;
            transition: all 0.2s;
        }
        
        button:hover {
            background: #333;
            color: white;
        }
        
        button.active {
            background: #4CAF50;
            border-color: #4CAF50;
            color: white;
        }
        
        .piano-container {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .piano {
            position: relative;
            display: flex;
            gap: 0;
        }
        
        .white-key {
            width: 70px;
            height: 280px;
            border: 2px solid #222;
            background: white;
            cursor: pointer;
            position: relative;
            transition: background 0.1s;
            user-select: none;
        }
        
        .white-key:hover {
            background: #f9f9f9;
        }
        
        .white-key.active {
            background: #ddd;
        }
        
        .white-key.configuring {
            background: #ffe082;
            animation: pulse 0.8s infinite;
        }
        
        .white-key .note {
            position: absolute;
            bottom: 35px;
            width: 100%;
            text-align: center;
            font-size: 20px;
            font-weight: 700;
            color: #333;
        }
        
        .white-key .key-label {
            position: absolute;
            bottom: 4px;
            width: 100%;
            text-align: center;
            font-size: 20px;
            font-weight: 700;
            color: #666;
            text-transform: uppercase;
        }
        
        .black-keys {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
        }
        
        .black-key {
            width: 45px;
            height: 175px;
            background: #000;
            border-radius: 0 0 4px 4px;
            cursor: pointer;
            position: absolute;
            pointer-events: auto;
            transition: background 0.1s;
            user-select: none;
        }
        
        .black-key:hover {
            background: #333;
        }
        
        .black-key.active {
            background: #555;
        }
        
        .black-key.configuring {
            background: #ffb300;
            animation: pulse 0.8s infinite;
        }
        
        .black-key .note {
            position: absolute;
            bottom: 35px;
            width: 100%;
            text-align: center;
            font-size: 20px;
            font-weight: 700;
            color: white;
        }
        
        .black-key .key-label {
            position: absolute;
            bottom: 4px;
            width: 100%;
            text-align: center;
            font-size: 20px;
            font-weight: 700;
            color: #ccc;
            text-transform: uppercase;
        }
        
        .instructions {
            margin-top: 25px;
            font-size: 14px;
            color: #666;
            font-weight: 300;
            text-align: center;
            max-width: 600px;
        }
        
        .config-message {
            margin-top: 15px;
            padding: 15px;
            background: #ffe082;
            border-radius: 5px;
            font-size: 14px;
            color: #333;
            font-weight: 500;
            display: none;
        }
        
        .config-message.show {
            display: block;
        }
        
        .version-badge {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #FF5722;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .loading-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 20px 40px;
            border-radius: 10px;
            font-size: 16px;
            z-index: 1000;
            display: none;
        }
        
        .loading-message.show {
            display: block;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
    </style>
</head>
<body>
    <div class="version-badge">Piano Real</div>
    <div class="loading-message" id="loadingMessage">Cargando samples de piano...</div>
    
    <h1>Piano Koki</h1>
    
    <div class="controls">
        <button id="configBtn">‚öôÔ∏è Configurar Teclas</button>
        <button id="resetBtn">üîÑ Restablecer</button>
    </div>
    
    <div class="piano-container">
        <div class="piano" id="piano">
            <!-- Teclas blancas -->
        </div>
        <div class="black-keys" id="blackKeys">
            <!-- Teclas negras -->
        </div>
    </div>
    
    <div class="config-message" id="configMessage">
        Haz clic en una tecla del piano, luego presiona la tecla de tu teclado que quieres asignarle
    </div>
    
    <p class="instructions" id="instructions">
        Usa las teclas de tu teclado: a-s-d-f-g-h-j-k-l-√±-{-}-4-5-6 (blancas) | w-e-t-y-u-i-o-p-'-+ (negras)
    </p>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script>
        // Mostrar mensaje de carga
        document.getElementById('loadingMessage').classList.add('show');
        
        // Crear sampler con samples reales de piano
        const sampler = new Tone.Sampler({
            urls: {
                "A0": "A0.mp3", "C1": "C1.mp3", "D#1": "Ds1.mp3", "F#1": "Fs1.mp3",
                "A1": "A1.mp3", "C2": "C2.mp3", "D#2": "Ds2.mp3", "F#2": "Fs2.mp3",
                "A2": "A2.mp3", "C3": "C3.mp3", "D#3": "Ds3.mp3", "F#3": "Fs3.mp3",
                "A3": "A3.mp3", "C4": "C4.mp3", "D#4": "Ds4.mp3", "F#4": "Fs4.mp3",
                "A4": "A4.mp3", "C5": "C5.mp3", "D#5": "Ds5.mp3", "F#5": "Fs5.mp3",
                "A5": "A5.mp3", "C6": "C6.mp3", "D#6": "Ds6.mp3", "F#6": "Fs6.mp3",
                "A6": "A6.mp3", "C7": "C7.mp3", "D#7": "Ds7.mp3", "F#7": "Fs7.mp3",
                "A7": "A7.mp3", "C8": "C8.mp3"
            },
            release: 1.5,
            baseUrl: "https://nbrosowsky.github.io/tonejs-instruments/samples/piano/",
            onload: () => { 
                console.log("Piano ac√∫stico de alta calidad cargado");
                
                // --- ESTO ES LO QUE FALTA ---
                // Buscamos el elemento que dice "Cargando..." y lo ocultamos
                const loadingStatus = document.getElementById('loadingStatus'); 
                if (loadingStatus) {
                    loadingStatus.style.display = 'none';
                }
            }
        }).toDestination();
        
        // Reverberaci√≥n para realismo ac√∫stico
        const reverb = new Tone.Reverb({ decay: 2.5, wet: 0.3 }).toDestination();
        sampler.connect(reverb);
        
        const pressedKeys = new Set();
        const activeNotes = {};
        let configMode = false;
        let selectedKeyIndex = null;
        let selectedKeyType = null;

        const defaultWhiteKeys = [
            { note: 'Do', key: 'a', freq: 'C4' },
            { note: 'Re', key: 's', freq: 'D4' },
            { note: 'Mi', key: 'd', freq: 'E4' },
            { note: 'Fa', key: 'f', freq: 'F4' },
            { note: 'Sol', key: 'g', freq: 'G4' },
            { note: 'La', key: 'h', freq: 'A4' },
            { note: 'Si', key: 'j', freq: 'B4' },
            { note: 'Do', key: 'k', freq: 'C5' },
            { note: 'Re', key: 'l', freq: 'D5' },
            { note: 'Mi', key: '√±', freq: 'E5' },
            { note: 'Fa', key: '{', freq: 'F5' },
            { note: 'Sol', key: '}', freq: 'G5' },
            { note: 'La', key: '4', freq: 'A5' },
            { note: 'Si', key: '5', freq: 'B5' },
            { note: 'Do', key: '6', freq: 'C6' },
        ];

        const defaultBlackKeys = [
            { note: 'Di', key: 'w', freq: 'C#4', position: 0.5 },
            { note: 'Ri', key: 'e', freq: 'D#4', position: 1.5 },
            { note: 'Fi', key: 't', freq: 'F#4', position: 3.5 },
            { note: 'Sil', key: 'y', freq: 'G#4', position: 4.5 },
            { note: 'Li', key: 'u', freq: 'A#4', position: 5.5 },
            { note: 'Di', key: 'i', freq: 'C#5', position: 7.5 },
            { note: 'Ri', key: 'o', freq: 'D#5', position: 8.5 },
            { note: 'Fi', key: 'p', freq: 'F#5', position: 10.5 },
            { note: 'Sil', key: "'", freq: 'G#5', position: 11.5 },
            { note: 'Li', key: '+', freq: 'A#5', position: 12.5 },
        ];

        let whiteKeys = JSON.parse(localStorage.getItem('whiteKeys_samples')) || [...defaultWhiteKeys];
        let blackKeys = JSON.parse(localStorage.getItem('blackKeys_samples')) || [...defaultBlackKeys];

        function saveConfig() {
            localStorage.setItem('whiteKeys_samples', JSON.stringify(whiteKeys));
            localStorage.setItem('blackKeys_samples', JSON.stringify(blackKeys));
        }

// CAMBIO GEMINI

        function playNote(key, noteFreq) {
            // Tone.start() no necesita 'await' aqu√≠, puede ejecutarse en segundo plano
            if (Tone.context.state !== 'running') {
                Tone.start();
            }
            
            // 1. Convertimos la frecuencia num√©rica al nombre de la nota MIDI (ej: "C4")
            const noteName = freqToNote(noteFreq); 
            
            // 2. Si la nota ya est√° activa, la soltamos primero para que no se encime feo
            if (activeNotes[key]) {
                sampler.triggerRelease(activeNotes[key]);
            }
            
            // 3. Disparamos el sonido ac√∫stico
            // El 0.8 es el "volumen" (velocity) para que suene m√°s natural
            sampler.triggerAttack(noteName, Tone.now(), 0.8);
            
            // 4. Guardamos qu√© nota est√° sonando en esta tecla
            activeNotes[key] = noteName;
        }

// FIN DE CAMBIO GEMINI

        function stopNote(key) {
            if (activeNotes[key]) {
                sampler.triggerRelease(activeNotes[key]);
                delete activeNotes[key];
            }
        }

        function handleKeyDown(key) {
            if (configMode) return;
            if (pressedKeys.has(key)) return;
            pressedKeys.add(key);
            
            const keyElement = document.querySelector(`[data-key="${key}"]`);
            if (keyElement) {
                keyElement.classList.add('active');
            }
            
            const allKeys = [...whiteKeys, ...blackKeys];
            const keyData = allKeys.find(k => k.key === key);
            if (keyData) {
                playNote(key, keyData.freq);
            }
        }

        function handleKeyUp(key) {
            if (configMode) return;
            pressedKeys.delete(key);
            
            const keyElement = document.querySelector(`[data-key="${key}"]`);
            if (keyElement) {
                keyElement.classList.remove('active');
            }
            
            stopNote(key);
        }

        function renderPiano() {
            const pianoDiv = document.getElementById('piano');
            const blackKeysDiv = document.getElementById('blackKeys');
            
            pianoDiv.innerHTML = '';
            blackKeysDiv.innerHTML = '';

            whiteKeys.forEach((keyData, idx) => {
                const keyDiv = document.createElement('div');
                keyDiv.className = 'white-key';
                keyDiv.dataset.key = keyData.key;
                keyDiv.dataset.index = idx;
                keyDiv.dataset.type = 'white';
                keyDiv.innerHTML = `
                    <div class="note">${keyData.note}</div>
                    <div class="key-label">${keyData.key}</div>
                `;
                
                keyDiv.addEventListener('mousedown', (e) => {
                    if (configMode) {
                        selectKeyForConfig(idx, 'white');
                    } else {
                        handleKeyDown(keyData.key);
                    }
                });
                keyDiv.addEventListener('mouseup', () => !configMode && handleKeyUp(keyData.key));
                keyDiv.addEventListener('mouseleave', () => !configMode && handleKeyUp(keyData.key));
                
                pianoDiv.appendChild(keyDiv);
            });

            blackKeys.forEach((keyData, idx) => {
                const keyDiv = document.createElement('div');
                keyDiv.className = 'black-key';
                keyDiv.dataset.key = keyData.key;
                keyDiv.dataset.index = idx;
                keyDiv.dataset.type = 'black';
                keyDiv.style.left = `${52.5 + keyData.position * 70}px`;
                keyDiv.innerHTML = `
                    <div class="note">${keyData.note}</div>
                    <div class="key-label">${keyData.key}</div>
                `;
                
                keyDiv.addEventListener('mousedown', (e) => {
                    if (configMode) {
                        selectKeyForConfig(idx, 'black');
                    } else {
                        handleKeyDown(keyData.key);
                    }
                });
                keyDiv.addEventListener('mouseup', () => !configMode && handleKeyUp(keyData.key));
                keyDiv.addEventListener('mouseleave', () => !configMode && handleKeyUp(keyData.key));
                
                blackKeysDiv.appendChild(keyDiv);
            });
        }

        function selectKeyForConfig(index, type) {
            document.querySelectorAll('.configuring').forEach(el => {
                el.classList.remove('configuring');
            });

            selectedKeyIndex = index;
            selectedKeyType = type;

            const keyElement = document.querySelector(`[data-index="${index}"][data-type="${type}"]`);
            if (keyElement) {
                keyElement.classList.add('configuring');
            }
        }

        function toggleConfigMode() {
            configMode = !configMode;
            const configBtn = document.getElementById('configBtn');
            const configMessage = document.getElementById('configMessage');
            
            if (configMode) {
                configBtn.classList.add('active');
                configBtn.textContent = '‚úì Configurando...';
                configMessage.classList.add('show');
            } else {
                configBtn.classList.remove('active');
                configBtn.textContent = '‚öôÔ∏è Configurar Teclas';
                configMessage.classList.remove('show');
                document.querySelectorAll('.configuring').forEach(el => {
                    el.classList.remove('configuring');
                });
                selectedKeyIndex = null;
                selectedKeyType = null;
            }
        }

        function resetToDefault() {
            if (confirm('¬øRestaurar la configuraci√≥n original del teclado?')) {
                whiteKeys = [...defaultWhiteKeys];
                blackKeys = [...defaultBlackKeys];
                saveConfig();
                renderPiano();
            }
        }

        document.getElementById('configBtn').addEventListener('click', toggleConfigMode);
        document.getElementById('resetBtn').addEventListener('click', resetToDefault);

        window.addEventListener('keydown', (e) => {
            if (configMode && selectedKeyIndex !== null) {
                e.preventDefault();
                const newKey = e.key.toLowerCase();
                
                if (selectedKeyType === 'white') {
                    whiteKeys[selectedKeyIndex].key = newKey;
                } else {
                    blackKeys[selectedKeyIndex].key = newKey;
                }
                
                saveConfig();
                renderPiano();
                
                document.querySelectorAll('.configuring').forEach(el => {
                    el.classList.remove('configuring');
                });
                selectedKeyIndex = null;
                selectedKeyType = null;
            } else {
                handleKeyDown(e.key.toLowerCase());
            }
        });

        window.addEventListener('keyup', (e) => {
            handleKeyUp(e.key.toLowerCase());
        });

        renderPiano();
    </script>
</body>
</html>
